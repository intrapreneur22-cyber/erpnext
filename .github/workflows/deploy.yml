name: Local Deploy ERPNext Bench

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: self-hosted
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Deploy Local Bench
        run: |
          # Use bash explicitly
          export PATH=$PATH:/usr/local/bin:/home/frappe/.local/bin
          
          cd /home/frappe/frappe-bench
          
          # 1. Clear local changes that might block git pull
          git checkout .
          git pull origin main
          
          # 2. Update the database
          # Use the full path for bench just in case
          /usr/local/bin/bench migrate
          
          # 3. Clear cache and restart
          /usr/local/bin/bench clear-cache
          /usr/local/bin/bench restart
