name: Local Deploy ERPNext Bench

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: self-hosted
    
    steps:
      - name: Deploy Local Bench
        run: |
          # Redirect all output to a log file we can read
          LOG_FILE="/home/frappe/frappe-bench/deployment.log"
          exec > >(tee -a "$LOG_FILE") 2>&1
          
          echo "=== Deployment Started: $(date) ==="
          export PATH=$PATH:/usr/local/bin:/home/frappe/.local/bin
          
          cd /home/frappe/frappe-bench
          
          echo "--- Git Operations ---"
          # Force clean and reset to match GitHub exactly
          git fetch origin main
          git reset --hard origin/main
          git clean -fd
          
          echo "--- Bench Migrate ---"
          /usr/local/bin/bench migrate
          
          echo "--- Bench Post-Deploy ---"
          /usr/local/bin/bench clear-cache
          /usr/local/bin/bench restart
          
          echo "=== Deployment Finished Successfully ==="
